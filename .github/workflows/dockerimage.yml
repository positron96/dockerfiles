name: Docker Image CI

on: 
  push:
    branches:    
      - master
    tags:
      - release.*
env:
  GIT_SHA: ${{ github.sha }}
  #REG_HOST: ${{ secrets.DOCKER_REGISTRY_HOST }}
  #REG_PATH: ${{ secrets.DOCKER_REGISTRY }}
  REG_HOST: ghcr.io  
  REG_PATH: ${{ github.repository }}
  REG_USER: ${{ github.actor }}
  REG_PASS: ${{ secrets.GITHUB_TOKEN }}

jobs:
     
  modified-folders:    
    runs-on: ubuntu-latest
    env:
      OUTFILE: folders.txt
      
    outputs:
      need_updates: ${{ steps.check_need_updates.outputs.need_updates }}
    
    steps:
    - uses: actions/checkout@v1
    - name: create file list
      run: python .github/modified-images.py
    - name: Calculate number of folders
      id: check_need_updates
      run: |
          [ -s "$OUTFILE" ] && echo "::set-output name=need_updates::1" || echo "::set-output name=need_updates::0"
    - name: upload folder list
      uses: actions/upload-artifact@v1
      with:
        name: folder-list
        path: folders.txt

  build:

    runs-on: ubuntu-latest
    needs: modified-folders
    
    if: needs.modified-folders.outputs.need_updates==1

    steps:
    - uses: actions/checkout@v1
    - name: get folder list
      uses: actions/download-artifact@v1
      with:
        name: folder-list

#    - name: Login to GitHub Docker Registry
#      env:
#        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME || github.actor }}
#        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD || secrets.GITHUB_TOKEN }}
#      run: docker login $DOCKER_REGISTRY_HOST --username $DOCKER_USERNAME --password $DOCKER_PASSWORD  

    - name: Log in to registry
      uses: docker/login-action@v1
      with:
          registry: ${{ env.REG_HOST }}
          username: ${{ env.REG_USER }}
          password: ${{ env.REG_PASS }}

    - name: Build the images
      run: |
        env
        echo "Will build these directories:"
        cat folder-list/folders.txt
        echo '=================='
        while read f TAG VER; do 
          echo '==================='
          echo Folder $f, will be tagged as $TAG:$VER
          docker build $f/ --tag $TAG:$VER --tag $TAG:latest
          docker history $TAG:$VER
          docker push $TAG:$VER
          docker push $TAG:latest
        done < folder-list/folders.txt
